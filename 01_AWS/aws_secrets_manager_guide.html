<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Secrets Manager - Deep Dive</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.8;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 50px;
            text-align: center;
        }

        header h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.3em;
            opacity: 0.95;
        }

        .content {
            padding: 50px;
        }

        h2 {
            color: #1e40af;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 2em;
        }

        h3 {
            color: #4338ca;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .problem-box {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 6px solid #dc2626;
            padding: 25px;
            margin: 25px 0;
            border-radius: 10px;
        }

        .solution-box {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 6px solid #10b981;
            padding: 25px;
            margin: 25px 0;
            border-radius: 10px;
        }

        .insight-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 6px solid #f59e0b;
            padding: 25px;
            margin: 25px 0;
            border-radius: 10px;
        }

        .step-box {
            background: #f8fafc;
            border-left: 4px solid #667eea;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .step-box h3 {
            margin-top: 0;
            color: #667eea;
        }

        code {
            background: #1e293b;
            color: #fbbf24;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            border: 2px solid #475569;
            line-height: 1.6;
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .timeline {
            background: #0f172a;
            color: #cbd5e1;
            padding: 30px;
            border-radius: 10px;
            margin: 25px 0;
            font-family: 'Courier New', monospace;
        }

        .timeline-row {
            display: grid;
            grid-template-columns: 80px 200px 250px 200px;
            gap: 20px;
            padding: 12px 0;
            border-bottom: 1px solid #334155;
        }

        .timeline-row:first-child {
            font-weight: bold;
            color: #38bdf8;
        }

        .status-ok {
            color: #4ade80;
        }

        .status-transition {
            color: #fbbf24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        th {
            background: #1e40af;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f8fafc;
        }

        ul,
        ol {
            margin-left: 30px;
            margin-bottom: 20px;
        }

        li {
            margin-bottom: 12px;
        }

        strong {
            color: #1e40af;
        }

        .emoji {
            font-size: 1.3em;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üîê AWS Secrets Manager</h1>
            <p>Understanding Secret Rotation from First Principles</p>
        </header>

        <div class="content">
            <h2><span class="emoji">üéØ</span> The Core Problem</h2>

            <div class="problem-box">
                <h3>Why can't we just hardcode passwords?</h3>
                <p>Not "because it's insecure" (too vague), but these specific failure modes:</p>
                <ul>
                    <li><strong>Code Leaks ‚Üí Credential Leaks:</strong> Push to GitHub? Your password is public.</li>
                    <li><strong>Code Reuse ‚Üí Shared Passwords:</strong> Dev and prod use same code = same password.
                        Breach spreads.</li>
                    <li><strong>Rotation ‚Üí Redeployment Required:</strong> Want to change password? Redeploy entire
                        application.</li>
                    <li><strong>No Audit Trail:</strong> Can't see who accessed credentials or when.</li>
                </ul>
            </div>

            <div class="solution-box">
                <h3>The Solution: Externalize Secrets</h3>
                <p>Store credentials <strong>outside</strong> the code, fetch them at runtime:</p>
                <pre><code>‚ùå BAD:  password = "MySecretPass123"
‚úÖ GOOD: password = get_secret('snowflake/prod/credentials')</code></pre>
            </div>

            <h2><span class="emoji">üîÑ</span> The Rotation Challenge</h2>

            <h3>The Naive Approach (Why It Breaks)</h3>

            <div class="problem-box">
                <p>Imagine this simple rotation:</p>
                <pre><code>1. Generate new password
2. Update it in Snowflake
3. Done!</code></pre>

                <p><strong>What breaks:</strong></p>
                <pre><code>12:00:00 - Old password works ‚úÖ
12:00:01 - You change password in Snowflake
12:00:02 - Your app tries the OLD password (cached)
12:00:03 - ‚ùå CONNECTION FAILED - App crashes</code></pre>

                <p><strong>The Issue:</strong> There's a moment where the secret is updated but the app hasn't fetched
                    it yet. You need <strong>overlap</strong> - both passwords should work briefly.</p>
            </div>

            <h2><span class="emoji">‚öôÔ∏è</span> The 4-Step Rotation Process</h2>

            <p>AWS Secrets Manager uses a <strong>zero-downtime</strong> rotation pattern. Here's why each step exists:
            </p>

            <div class="step-box">
                <h3>Step 1: createSecret - Create the New Version</h3>
                <pre><code>new_password = generate_random_password()

# Store it with PENDING label
# DON'T update Snowflake yet!
secrets_manager.put_secret_value(
    SecretId='snowflake/prod',
    SecretString=json.dumps({'password': new_password}),
    VersionStages=['AWSPENDING']  # Not "CURRENT" yet!
)</code></pre>

                <p><strong>Why this step:</strong> The new secret exists in Secrets Manager, but <strong>nothing uses it
                        yet</strong>. No risk of breaking anything.</p>
            </div>

            <div class="step-box">
                <h3>Step 2: setSecret - Update the Database</h3>
                <pre><code># Connect with OLD password
snowflake_conn = connect_with_old_password()

# Change the password in Snowflake
snowflake_conn.execute(
    f"ALTER USER my_user SET PASSWORD = '{new_password}'"
)</code></pre>

                <p><strong>Why this step:</strong> Now Snowflake accepts <strong>BOTH</strong> passwords:</p>
                <ul>
                    <li>Old password (still labeled CURRENT in Secrets Manager)</li>
                    <li>New password (labeled PENDING in Secrets Manager)</li>
                </ul>

                <div class="insight-box">
                    <strong>üí° This is the overlap period.</strong> Apps using the old password still work!
                </div>
            </div>

            <div class="step-box">
                <h3>Step 3: testSecret - Verify It Works</h3>
                <pre><code># Try to connect with the NEW password
test_conn = snowflake.connector.connect(
    user='my_user',
    password=new_password,  # The PENDING password
    account='abc123'
)

# Run a simple test
test_conn.cursor().execute("SELECT 1")
test_conn.close()</code></pre>

                <p><strong>Why this step:</strong> If this fails, we <strong>abort</strong>! The rotation failed safely
                    because apps are still using the old password.</p>
            </div>

            <div class="step-box">
                <h3>Step 4: finishSecret - Make It Current</h3>
                <pre><code># Mark the new password as CURRENT
secrets_manager.update_secret_version_stage(
    SecretId='snowflake/prod',
    VersionStage='CURRENT',
    MoveToVersionId=new_version_id,
    RemoveFromVersionId=old_version_id
)

# (Optional) After grace period, revoke old password</code></pre>

                <p><strong>Why this step:</strong> Now:</p>
                <ul>
                    <li>New fetches get the new password (CURRENT)</li>
                    <li>Old fetches (with cached version) still work briefly</li>
                    <li>After N minutes, you can delete the old password</li>
                </ul>
            </div>

            <h2><span class="emoji">‚è±Ô∏è</span> The Timeline (Zero Downtime)</h2>

            <div class="timeline">
                <div class="timeline-row">
                    <div>Time</div>
                    <div>Secrets Manager</div>
                    <div>Snowflake Accepts</div>
                    <div>App State</div>
                </div>
                <div class="timeline-row">
                    <div>T+0</div>
                    <div>Old=CURRENT</div>
                    <div>Old password</div>
                    <div class="status-ok">‚úÖ Working</div>
                </div>
                <div class="timeline-row">
                    <div>T+1</div>
                    <div>Old=CURRENT<br>New=PENDING</div>
                    <div>Old password</div>
                    <div class="status-ok">‚úÖ Working</div>
                </div>
                <div class="timeline-row">
                    <div>T+2</div>
                    <div>Old=CURRENT<br>New=PENDING</div>
                    <div>Old OR New<br>(both work!)</div>
                    <div class="status-transition">‚ö†Ô∏è Overlap</div>
                </div>
                <div class="timeline-row">
                    <div>T+3</div>
                    <div>Old=CURRENT<br>New=PENDING</div>
                    <div>Old OR New<br>(test succeeds)</div>
                    <div class="status-transition">‚ö†Ô∏è Testing</div>
                </div>
                <div class="timeline-row">
                    <div>T+4</div>
                    <div>New=CURRENT<br>Old=PREVIOUS</div>
                    <div>Old OR New<br>(grace period)</div>
                    <div class="status-ok">‚úÖ Migrating</div>
                </div>
                <div class="timeline-row">
                    <div>T+10</div>
                    <div>New=CURRENT</div>
                    <div>New only</div>
                    <div class="status-ok">‚úÖ Complete</div>
                </div>
            </div>

            <h2><span class="emoji">‚ùå</span> Failure Handling</h2>

            <table>
                <thead>
                    <tr>
                        <th>Failure Point</th>
                        <th>What Happens</th>
                        <th>Recovery</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Step 1 fails</strong></td>
                        <td>Can't create new secret</td>
                        <td>‚úÖ Safe - No changes made, just retry</td>
                    </tr>
                    <tr>
                        <td><strong>Step 2 fails</strong></td>
                        <td>New secret exists but DB unchanged</td>
                        <td>‚úÖ Safe - Old password still works</td>
                    </tr>
                    <tr>
                        <td><strong>Step 3 fails</strong></td>
                        <td>Lambda detects bad password</td>
                        <td>‚úÖ Safe - Abort rotation, old password active</td>
                    </tr>
                    <tr>
                        <td><strong>Step 4 fails</strong></td>
                        <td>Both passwords work indefinitely</td>
                        <td>‚ö†Ô∏è Manual - Mark CURRENT or retry</td>
                    </tr>
                    <tr>
                        <td><strong>Lambda crashes</strong></td>
                        <td>Rotation incomplete</td>
                        <td>‚úÖ Safe - PENDING version not CURRENT</td>
                    </tr>
                </tbody>
            </table>

            <h2><span class="emoji">üé§</span> Interview Answer</h2>

            <div class="insight-box">
                <h3>Question: "How does automatic rotation work?"</h3>

                <p><strong>Your Answer:</strong></p>
                <p>"Rotation is a four-step process designed for zero downtime. First, a new secret version is created
                    but labeled <code>PENDING</code> - nothing uses it yet. Second, the database password is updated, so
                    now both old and new passwords work. Third, the Lambda tests the new password by connecting to the
                    database. If successful, step four marks it as <code>CURRENT</code>. This overlap period means apps
                    using cached credentials don't break. If any step fails, the rotation aborts safely because the old
                    password is still active."</p>

                <h3>Follow-up: "What if the Lambda crashes mid-rotation?"</h3>

                <p><strong>Your Answer:</strong></p>
                <p>"The <code>PENDING</code> version exists but isn't <code>CURRENT</code>, so apps still use the old
                    password. You can either retry the rotation or manually rollback by deleting the
                    <code>PENDING</code> version. The key design principle is that rotation only completes when we've
                    verified the new secret works."</p>
            </div>

            <h2><span class="emoji">üêç</span> Python Implementation</h2>

            <h3>Fetching Secrets (The Code You'll Actually Write)</h3>

            <pre><code>import boto3
import json
from botocore.exceptions import ClientError

def get_secret(secret_name, region_name="us-east-1"):
    """Retrieve secret from AWS Secrets Manager."""
    client = boto3.client('secretsmanager', region_name=region_name)
    
    try:
        response = client.get_secret_value(SecretId=secret_name)
        return json.loads(response['SecretString'])
    except ClientError as e:
        # Handle errors (network, permissions, etc.)
        print(f"Error retrieving secret: {e}")
        raise

# Usage
secret = get_secret('snowflake/prod/credentials')
password = secret['password']  # Gets the CURRENT version</code></pre>

            <h3>Connecting to Snowflake</h3>

            <pre><code>import snowflake.connector

def connect_to_snowflake():
    secret = get_secret('snowflake/prod/credentials')
    
    conn = snowflake.connector.connect(
        user=secret['username'],
        password=secret['password'],
        account=secret['account'],
        warehouse=secret['warehouse'],
        database=secret['database'],
        schema=secret['schema'],
        role=secret['role']
    )
    
    return conn</code></pre>

            <h2><span class="emoji">üéì</span> What You Actually Need to Know</h2>

            <div class="solution-box">
                <h3>Essential (Must Understand)</h3>
                <ul>
                    <li>Why hardcoding credentials is dangerous (specific failure modes)</li>
                    <li>The overlap concept (why rotation needs 4 steps)</li>
                    <li>How IAM roles grant access (not access keys)</li>
                    <li>Error handling (what if Secrets Manager is down?)</li>
                </ul>
            </div>

            <div class="insight-box">
                <h3>Nice to Have (Job Dependent)</h3>
                <ul>
                    <li>Lambda function syntax (Google it)</li>
                    <li>SNS notification setup (Copy from docs)</li>
                    <li>IAM policy JSON (Use AWS generator)</li>
                </ul>
            </div>

            <h2><span class="emoji">üí°</span> Key Takeaways</h2>

            <ol>
                <li><strong>The Problem:</strong> Hardcoded credentials leak, can't rotate, no audit trail</li>
                <li><strong>The Solution:</strong> Externalize secrets, fetch at runtime</li>
                <li><strong>The Challenge:</strong> Can't just "change password" - need overlap</li>
                <li><strong>The Pattern:</strong> Create ‚Üí Set ‚Üí Test ‚Üí Finish (4 steps)</li>
                <li><strong>The Safety:</strong> Each step is reversible; old password works until new is verified</li>
            </ol>

            <div class="solution-box">
                <p style="font-size: 1.2em; text-align: center; margin: 0;">
                    <strong>Remember:</strong> Your value isn't memorizing APIs. It's understanding <em>why</em> systems
                    are designed this way and <em>what happens when they fail</em>.
                </p>
            </div>
        </div>
    </div>
</body>

</html>