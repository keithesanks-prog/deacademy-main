# ðŸ”— SQL Function Chains: Visual Breakdown

**How nested functions work from the inside out**

---

## ðŸŽ¯ Example 1: Compound Interest Calculation

### **The Full Expression:**
```sql
TRUNCATE(start_price * POWER(1 + rate/100, months), 2)
```

### **Visual Breakdown (Inside â†’ Out):**

```
Step 1: Calculate the rate adjustment
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   1 + rate/100      â”‚
â”‚   1 + 0.67/100      â”‚
â”‚   1 + 0.0067        â”‚
â”‚   = 1.0067          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 2: Raise to the power of months
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POWER(1.0067, 7)   â”‚
â”‚  1.0067^7           â”‚
â”‚  = 1.0476           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 3: Multiply by start price
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  116.95 * 1.0476    â”‚
â”‚  = 122.5168         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 4: Truncate to 2 decimals
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRUNCATE(122.5168, 2)â”‚
â”‚  = 122.51           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **With Actual Data:**

| Input | Step | Calculation | Result |
|-------|------|-------------|--------|
| rate = 0.67, months = 7 | 1 | `1 + 0.67/100` | 1.0067 |
| â†“ | 2 | `POWER(1.0067, 7)` | 1.0476 |
| start_price = 116.95 | 3 | `116.95 Ã— 1.0476` | 122.5168 |
| â†“ | 4 | `TRUNCATE(122.5168, 2)` | **122.51** |

---

## ðŸŽ¯ Example 2: Window Function with Partition

### **The Full Expression:**
```sql
RANK() OVER (PARTITION BY category ORDER BY video_views DESC)
```

### **Visual Breakdown:**

```
Step 1: PARTITION BY category (Split into groups)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gaming Group                â”‚
â”‚  youtuber  | video_views            â”‚
â”‚  Alice     | 50000                  â”‚
â”‚  Bob       | 30000                  â”‚
â”‚  Charlie   | 20000                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Music Group                 â”‚
â”‚  youtuber  | video_views            â”‚
â”‚  Eve       | 40000                  â”‚
â”‚  Frank     | 25000                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 2: ORDER BY video_views DESC (Sort within each group)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gaming Group (Sorted)       â”‚
â”‚  youtuber  | video_views            â”‚
â”‚  Alice     | 50000  â† Highest       â”‚
â”‚  Bob       | 30000                  â”‚
â”‚  Charlie   | 20000  â† Lowest        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Music Group (Sorted)        â”‚
â”‚  youtuber  | video_views            â”‚
â”‚  Eve       | 40000  â† Highest       â”‚
â”‚  Frank     | 25000  â† Lowest        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 3: RANK() (Assign ranks within each group)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gaming Group (Ranked)       â”‚
â”‚  youtuber  | video_views | RANK    â”‚
â”‚  Alice     | 50000       | 1       â”‚
â”‚  Bob       | 30000       | 2       â”‚
â”‚  Charlie   | 20000       | 3       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Music Group (Ranked)        â”‚
â”‚  youtuber  | video_views | RANK    â”‚
â”‚  Eve       | 40000       | 1       â”‚
â”‚  Frank     | 25000       | 2       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Final Result (Combined):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ youtuber â”‚ video_views â”‚ RANK â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ Alice    â”‚ 50000       â”‚  1   â”‚
â”‚ Bob      â”‚ 30000       â”‚  2   â”‚
â”‚ Charlie  â”‚ 20000       â”‚  3   â”‚
â”‚ Eve      â”‚ 40000       â”‚  1   â”‚ â† Rank resets!
â”‚ Frank    â”‚ 25000       â”‚  2   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸŽ¯ Example 3: EXTRACT with Date Arithmetic

### **The Full Expression:**
```sql
EXTRACT(MONTH FROM sale_date) - 1
```

### **Visual Breakdown:**

```
Input: sale_date = '2023-08-06'

Step 1: EXTRACT(MONTH FROM sale_date)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  '2023-08-06'       â”‚
â”‚       â†“             â”‚
â”‚  EXTRACT(MONTH)     â”‚
â”‚       â†“             â”‚
â”‚       8             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 2: Subtract 1
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      8 - 1          â”‚
â”‚       = 7           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: 7 months elapsed
```

### **With Multiple Dates:**

| sale_date | EXTRACT(MONTH) | Minus 1 | Result |
|-----------|----------------|---------|--------|
| 2023-01-15 | 1 | 1 - 1 | **0** months |
| 2023-03-20 | 3 | 3 - 1 | **2** months |
| 2023-08-06 | 8 | 8 - 1 | **7** months |
| 2023-11-30 | 11 | 11 - 1 | **10** months |

---

## ðŸŽ¯ Example 4: Nested CONCAT

### **The Full Expression:**
```sql
CONCAT(CONCAT(first_name, ' '), last_name)
```

### **Visual Breakdown:**

```
Input: first_name = 'John', last_name = 'Doe'

Step 1: Inner CONCAT (first_name + space)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONCAT('John', ' ') â”‚
â”‚       = 'John '     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 2: Outer CONCAT (result + last_name)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”
â”‚ CONCAT('John ', 'Doe') â”‚
â”‚       = 'John Doe'     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”˜
```

### **Simpler Version:**
```sql
CONCAT(first_name, ' ', last_name)
-- Same result, cleaner syntax!
```

---

## ðŸŽ¯ Example 5: Complex Subquery in HAVING

### **The Full Expression:**
```sql
HAVING SUM(order_amount) > (SELECT AVG(order_amount) FROM orders)
```

### **Visual Breakdown:**

```
Step 1: Execute the subquery (Global Average)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SELECT AVG(order_amount)           â”‚
â”‚  FROM orders                        â”‚
â”‚                                     â”‚
â”‚  (100 + 200 + 50 + 150 + 300) / 5   â”‚
â”‚  = 160                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 2: Calculate SUM per customer (GROUP BY)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ customer_id â”‚ SUM(amount)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      1      â”‚     300      â”‚
â”‚      2      â”‚     200      â”‚
â”‚      3      â”‚     300      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“

Step 3: Filter groups (HAVING)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ customer_id â”‚ SUM(amount)  â”‚ > 160?      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      1      â”‚     300      â”‚ âœ… YES      â”‚
â”‚      2      â”‚     200      â”‚ âœ… YES      â”‚
â”‚      3      â”‚     300      â”‚ âœ… YES      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

All customers kept (all > 160)
```

---

## ðŸ’¡ Reading Function Chains: The Rule

**Always read from the INSIDE OUT:**

```sql
TRUNCATE(start_price * POWER(1 + rate/100, months), 2)
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘
                    Do this first!

Order of execution:
1. rate/100
2. 1 + (result from #1)
3. POWER((result from #2), months)
4. start_price * (result from #3)
5. TRUNCATE((result from #4), 2)
```

---

## ðŸŽ¯ Practice: Break Down This Expression

```sql
ROUND(AVG(POWER(price, 2)), 1)
```

**Your turn! What's the order?**

<details>
<summary>Click to see answer</summary>

```
Step 1: POWER(price, 2)
  Example: 10^2 = 100

Step 2: AVG(...)
  Example: AVG(100, 144, 225) = 156.33

Step 3: ROUND(..., 1)
  Example: ROUND(156.33, 1) = 156.3
```
</details>
