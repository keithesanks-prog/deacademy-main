<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Solution: Your First Macro</title>
    <!-- Learning Tracker -->
    <script src="../learning_tracker.js"></script>
    <style>
        :root {
            --dbt-orange: #FF694B;
            --dbt-dark: #04192B;
            --dbt-blue: #00BFB3;
            --bg-light: #f8f9fa;
            --code-bg: #1e1e1e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-light);
        }

        h1 {
            color: var(--dbt-dark);
            border-bottom: 5px solid var(--dbt-blue);
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        h2 {
            color: var(--dbt-orange);
            margin-top: 40px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border-left: 5px solid var(--dbt-blue);
        }

        code {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: #eee;
            padding: 2px 5px;
            border-radius: 4px;
            color: #d63384;
        }

        pre {
            background-color: var(--code-bg);
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            border: 1px solid #333;
        }

        .comment {
            color: #6a9955;
        }

        .string {
            color: #ce9178;
        }

        .keyword {
            color: #569cd6;
        }

        .step-number {
            background: var(--dbt-dark);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body data-module-name="03_dbt_dbt_lab_macros">

    <h1>üß™ Lab: Writing Your First Macro</h1>
    <p>Macros are like functions in Python or Excel. They let you write code <strong>once</strong> and reuse it
        everywhere.</p>
    <p><strong>The Golden Rule: DRY (Don't Repeat Yourself).</strong></p>

    <div class="card" style="border-left-color: #dc3545;">
        <h2><span class="step-number">1</span> The Problem: Repetitive Math</h2>
        <p>Imagine you have 10 sources, and they all store revenue in <strong>cents</strong>. In every single staging
            model, you find yourself writing this:</p>
        <pre><code class="language-sql">select
    <!-- Nav -->
    <a href="../TRAINING_HUB.html" style="display: inline-block; margin: 20px; text-decoration: none; color: #333; font-weight: bold;">‚¨ÖÔ∏è Back to Hub</a>

    <div class="container">
        <h1>üß™ Lab: Writing Your First Macro</h1>
        <p>Macros are like functions in Python or Excel. They let you write code <strong>once</strong> and reuse it
            everywhere.</p>
        <p><strong>The Golden Rule: DRY (Don't Repeat Yourself).</strong></p>

        <div class="card" style="border-left-color: #dc3545;">
            <h2><span class="step-number">1</span> The Problem: Repetitive Math</h2>
            <p>Imagine you have 10 sources, and they all store revenue in <strong>cents</strong>. In every single staging
                model, you find yourself writing this:</p>
            <pre><code class="language-sql">select
    id,
    amount / 100 as amount_usd,  -- I wrote this 5 times today
    tax / 100 as tax_usd,        -- I wrote this 5 times today
    ...
from ...</code></pre>
        <p>If the logic changes (e.g., you need to round to 2 decimals), you have to fix it in 20 places.</p>
    </div>

    <div class="card">
        <h2><span class="step-number">2</span> Create the Macro</h2>
        <p>Macros live in the <code>macros/</code> folder. Let's create one.</p>
        <p><strong>File:</strong> <code>macros/cents_to_dollars.sql</code></p>

        <pre><code class="language-django">{% macro cents_to_dollars(column_name) -%}
    
    round( {{ column_name }} / 100.0, 2 )

{%- endmacro %}</code></pre>

        <p><strong>Breakdown:</strong>
        <ul>
            <li><code>{% macro name(args) %}</code>: Starts the definition.</li>
            <li><code>{{ column_name }}</code>: Injects the column name you pass in.</li>
        </ul>
        </p>
    </div>

    <div class="card" style="border-left-color: #28a745;">
        <h2><span class="step-number">3</span> Use the Macro</h2>
        <p>Now, go back to your staging model and use the function.</p>

        <pre><code class="language-sql">select
    id,
    
    -- Old way:
    -- amount / 100 as amount_usd,
    
    -- Macro way:
    {{ cents_to_dollars('amount') }} as amount_usd,
    {{ cents_to_dollars('tax') }} as tax_usd

from ...</code></pre>
    </div>

    <div class="card" style="border-left-color: #6610f2;">
        <h2><span class="step-number">4</span> Level Up: Optional Arguments</h2>
        <p>What if we want to control the decimal places? We can add a second argument with a default value.</p>

        <p><strong>Update <code>macros/cents_to_dollars.sql</code>:</strong></p>
        <pre><code class="language-django">{% macro cents_to_dollars(column_name, decimal_places=2) -%}
    round( 1.0 * {{ column_name }} / 100, {{ decimal_places }})
{%- endmacro %}</code></pre>

        <p><strong>Usage (Refactored stg_payments.sql):</strong></p>
        <pre><code class="language-sql">select
    id as payment_id,
    orderid as order_id,
    paymentmethod as payment_method,
    status,
    -- amount is stored in cents, convert it to dollars
    {{ cents_to_dollars('amount', 4) }} as amount,
    created as created_at
from {{ source('stripe','payment') }}</code></pre>
    </div>

    <footer style="text-align: center; margin-top: 50px; color: #888;">
        <p><em>Congratulations! You are now a tool builder, not just a tool user.</em> üõ†Ô∏è</p>
    </footer>

    <!-- AI Assistant -->
    <div id="ai-assistant-btn"
        style="position: fixed; bottom: 20px; right: 20px; background: #000; color: #fff; padding: 15px; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold; display: flex; align-items: center; gap: 10px; z-index: 1000; transition: transform 0.2s;">
        <span>ü§ñ</span> Ask AI
    </div>
    <div id="ai-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
        <div
            style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; position: relative;">
            <h2 style="margin-top: 0; color: #333;">ü§ñ AI Prompt Helper</h2>
            <p style="color: #666;">Copy to ChatGPT/Gemini:</p>
            <textarea id="ai-prompt-text"
                style="width: 100%; height: 150px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin: 15px 0; font-family: monospace;"></textarea>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="document.getElementById('ai-modal').style.display='none'"
                    style="padding: 10px 20px; border: none; background: #eee; cursor: pointer; border-radius: 5px;">Close</button>
                <button
                    onclick="navigator.clipboard.writeText(document.getElementById('ai-prompt-text').value); alert('Copied!')"
                    style="padding: 10px 20px; border: none; background: #FF6B4A; color: white; cursor: pointer; border-radius: 5px;">Copy
                    Prompt</button>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('ai-assistant-btn').onclick = () => document.getElementById('ai-modal').style.display = 'flex';
        document.getElementById('ai-prompt-text').value = `I am working on the "${document.title}" lab.\n\nI am confused about Macros and Jinja.\n\nCan you explain it simply?`; 
    </script>
</body>

</html>